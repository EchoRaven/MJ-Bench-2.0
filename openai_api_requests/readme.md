### API 并发请求执行脚本说明文档

#### 1. 简介
本项目提供了一个基于 Python 和 Shell 脚本的解决方案，用于并发调用 OpenAI API，并将结果保存到指定的文件中。脚本支持请求重试、异常处理以及在后台挂载执行，以便实现长时间运行不中断的请求处理。

#### 2. 前置条件
在运行脚本之前，请确保你已经具备以下环境：
- 安装了 Python 3.x 版本。
- 安装了 `openai` 相关依赖库（可通过 `pip install openai`）。
- 配置了 OpenAI API Key 并保存在 YAML 文件中。
- Linux 环境，支持 `bash` 及 `nohup`。

#### 3. 文件说明
项目中包含两个主要文件：
- **Python 脚本 (`api_requests.py`)**：用于处理并发调用 OpenAI API 请求，并将结果保存到输出文件。
- **Shell 脚本 (`run_api_requests.sh`)**：用于通过 `nohup` 方式后台运行 Python 脚本，并处理参数输入与日志保存。

#### 4. 参数说明

运行时需提供以下几个参数：
1. **`input_file`**：输入 JSON 文件的路径，包含需要处理的请求数据。
2. **`output_file`**：输出 JSON 文件的路径，保存 API 返回的响应数据。
3. **`config_file`**：YAML 配置文件的路径，包含 OpenAI 的 API Key。
4. **`max_workers`**：最大并发请求数量，用于控制同时发送的 API 请求数量。
5. **`log_file`**：日志文件的路径，用于保存后台运行过程中输出的日志信息。

#### 5. 使用方法

##### 5.1 准备输入文件和配置文件
- **输入文件**：确保你的输入文件为 JSON 格式，包含每个请求的 `id` 和 `body`。`body` 中应包含 `model type`、`max token`、`system prompt`、`user prompt` 等字段。
- **配置文件**：YAML 格式的配置文件，其中包含你的 OpenAI API Key。确保 API Key 字段名称正确。

##### 5.2 设置文件可执行权限
在首次运行之前，需要给 Shell 脚本赋予可执行权限：
```bash
chmod +x run_api_requests.sh
```

##### 5.3 运行脚本
使用 `nohup` 挂载脚本并后台执行。通过命令行传入必要的参数，如下所示：

```bash
./run_api_requests.sh input.json output.json openai_key.yaml 5 api_requests.log
```

- **input.json**：输入的请求文件。
- **output.json**：API 响应将保存到该文件中。
- **openai_key.yaml**：API 密钥配置文件。
- **5**：并发调用的最大数量。
- **api_requests.log**：日志文件路径，保存运行时的标准输出和错误输出。

##### 5.4 查看日志
执行后，所有输出信息将保存在日志文件中。你可以使用如下命令查看实时日志：
```bash
tail -f api_requests.log
```

#### 6. 注意事项
- **文件路径**：确保传入的文件路径正确，特别是输入文件和配置文件，路径需要是绝对路径或相对路径。
- **API 请求稳定性**：由于网络或其他原因，API 请求可能会中断或失败。脚本中设置了请求的最大重试次数，请确保合理设置以避免长时间的失败重试。
- **后台运行**：`nohup` 命令使脚本能够在后台运行，即使终端关闭，脚本仍会继续执行。
- **中断处理**：如果在脚本运行中途被中断，已完成的请求结果会保存在输出文件中，脚本在重启后不会重复处理已完成的请求。

#### 7. 常见问题
- **无法找到 Python 脚本**：确保 Python 脚本路径正确，并且使用 `python3` 或 `python` 版本时与实际的 Python 版本一致。
- **日志文件过大**：长时间运行的脚本可能会生成较大的日志文件，建议定期检查并根据需要清理日志文件。
- **API 错误处理**：如果频繁遇到 API 请求错误，检查是否超过 OpenAI 的 API 使用限额，或确认网络连接稳定性。

#### 8. 后续操作
- 检查输出文件中的请求结果，确保请求结果与预期一致。
- 可以根据需要修改最大并发数，调整脚本的并发请求量。
- 在高负载场景下，建议设置合理的重试次数和并发限制，以免请求失败或超时。

为了实现你的新需求，即添加 `--debug` 参数，启用时从数据集中抽样一部分数据用于测试 API 请求效果，从而减少开销。我们可以通过以下步骤来更新脚本：



### Update：

1. **新增 `--debug` 参数**：通过 `argparse` 添加该参数。如果该参数启用，则对输入数据集进行抽样（比如取 10 条数据）。
2. **数据抽样**：可以使用 `random.sample` 方法从输入数据集中随机抽取若干条数据作为测试集。
3. **保持原始逻辑不变**：如果没有启用 `--debug`，则按照正常流程处理全部数据。

#### 2. 新增参数说明
- **`--debug`**：启用调试模式。开启后，将对输入数据集进行抽样，而不是处理整个数据集，以减少 API 请求次数。
- **`--sample_size`**（可选）：当 `--debug` 参数启用时，控制从输入数据集中抽取的样本数量，默认为 10。如果用户没有指定该参数，则默认抽取 10 条数据进行测试。

#### 3. 使用方法

##### 3.1 调试模式运行
在调试模式下，脚本会从输入文件中随机抽取一部分数据进行测试，而不会处理整个数据集。可以通过传入 `--debug` 参数来启用此功能：
```bash
./run_api_requests.sh input.json output.json openai_key.yaml 5 api_requests.log --debug --sample_size 10
```
- `--debug`：启用调试模式，进行数据抽样。
- `--sample_size 10`：指定抽样的数量为 10 条数据。如果不指定，默认抽取 10 条。

##### 3.2 常规模式运行
不启用 `--debug` 时，脚本会处理整个数据集，如同之前的行为：
```bash
./run_api_requests.sh input.json output.json openai_key.yaml 5 api_requests.log
```

#### 4. 注意事项
- 调试模式仅用于测试阶段。在正式运行时，建议不启用 `--debug` 参数，以确保所有数据均被处理。
- **随机抽样**：每次运行时，调试模式下抽取的数据是随机的，因此可能每次的测试结果会有所不同。